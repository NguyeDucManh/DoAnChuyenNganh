{% load static %}
<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#D70018" />
  <title>Hệ thống quản lý giao hàng</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="{% static 'assets/css/style.css' %}" />
</head>
<body class="page-home">

  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="{% url 'home' %}">
        <i class="fa-solid fa-house"></i><span>Trang chủ</span>
      </a>

      <nav class="main-nav" id="mainNav">
        <a href="{% url 'home' %}" class="active">Trang chủ</a>
        <a href="#">Dịch vụ</a>
        <a href="#">Giới thiệu</a>
        <a href="#">Hỗ trợ</a>
      </nav>

      <div class="header-actions">
        <button id="themeToggle" class="icon-btn" aria-label="Chuyển giao diện">
          <i class="fa-solid fa-moon"></i>
        </button>

        {% if request.user.is_authenticated %}
        <div class="user-menu" id="userMenu">
          <button class="user-chip" id="userChip">
            <span class="avatar">{{ request.user.username|first|upper|default:"U" }}</span>
            <span>Xin chào, {{ request.user.username }}</span>
            <i class="fa-solid fa-chevron-down"></i>
          </button>
          <div class="menu" id="userDropdown">
            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" class="menu-btn menu-danger">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> Đăng xuất
              </button>
            </form>
          </div>
        </div>
        {% else %}
        <a class="btn pill primary" href="{% url 'login' %}?next={% url 'home' %}">Đăng nhập</a>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="hero-decor" aria-hidden="true">
      <span class="blob b1"></span><span class="blob b2"></span><span class="blob b3"></span>
    </div>

    <div class="container hero-inner">
      <h1>Quản lý & vận hành giao hàng tối ưu</h1>
      <p class="subtitle">Theo dõi đơn – điều phối tuyến – báo cáo hiệu suất trong một nơi.</p>

      <form id="trackForm" class="search" role="search" aria-label="Tra cứu vận đơn">
        <input id="trackInput" name="code" type="text" placeholder="Nhập mã vận đơn…" />
        <button class="btn pill primary" type="submit">
          <i class="fa-solid fa-magnifying-glass"></i> Tra cứu
        </button>
      </form>
      <div id="trackResult" class="track-result"></div>
    </div>

    <svg class="hero-anim" viewBox="0 0 1200 200">
      <path id="road" d="M20,150 C240,80 420,190 640,120 860,60 1040,170 1180,110"
            fill="none" stroke="currentColor" stroke-opacity=".12"
            stroke-width="3" stroke-linecap="round" stroke-dasharray="10 10"></path>
      <g id="truck" class="truck">
        <rect x="-22" y="-12" width="44" height="24" rx="4" ry="4" class="truck-body"/>
        <rect x="12" y="-10" width="18" height="20" rx="3" class="truck-cabin"/>
        <circle cx="-10" cy="14" r="5" class="wheel"/>
        <circle cx="10"  cy="14" r="5" class="wheel"/>
        <animateMotion dur="18s" begin="0s" repeatCount="indefinite" rotate="auto">
          <mpath xlink:href="#road" href="#road"></mpath>
        </animateMotion>
      </g>
    </svg>
  </section>

  <!-- Features -->
  <section class="section features">
    <div class="container grid-4">
      <article class="card glass">
        <div class="icon"><i class="fa-solid fa-box"></i></div>
        <h3>Quản lý đơn hàng</h3>
        <p>Theo dõi trạng thái và cập nhật đơn hàng dễ dàng.</p>
        <button onclick="location.href='{% url 'orders:list' %}'" class="link-btn">
          {% if request.user.is_staff %}Quản lý đơn hàng{% else %}Đơn hàng của tôi{% endif %}
          <i class="fa-solid fa-arrow-right"></i>
        </button>
      </article>

      <article class="card glass">
        <div class="icon"><i class="fa-solid fa-route"></i></div>
        <h3>Điều phối tuyến đường</h3>
        <p>Gợi ý lộ trình tối ưu cho nhân viên giao hàng.</p>
        <button class="link-btn" onclick="location.href='{% url 'orders:map' %}'">
          Khám phá <i class="fa-solid fa-arrow-right"></i>
        </button>
      </article>

      <article class="card glass">
        <div class="icon"><i class="fa-solid fa-chart-line"></i></div>
        <h3>Báo cáo & thống kê</h3>
        <p>Hiệu suất và chi phí vận hành rõ ràng.</p>
        <button class="link-btn">Xem báo cáo <i class="fa-solid fa-arrow-right"></i></button>
      </article>

      <article class="card glass">
        <div class="icon"><i class="fa-solid fa-shield-halved"></i></div>
        <h3>Bảo mật dữ liệu</h3>
        <p>Phân quyền người dùng, vai trò và chính sách truy cập.</p>
        <button class="link-btn" onclick="location.href='{% url 'security:overview' %}'">
          Tìm hiểu <i class="fa-solid fa-arrow-right"></i>
        </button>
      </article>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h4>Về chúng tôi</h4>
        <a href="#">Giới thiệu</a>
        <a href="#">Tuyển dụng</a>
      </div>
      <div>
        <h4>Hỗ trợ</h4>
        <a href="#">Trung tâm trợ giúp</a>
        <a href="#">Điều khoản</a>
      </div>
      <div>
        <h4>Liên hệ</h4>
        <a href="mailto:support@giaohang.com">support@giaohang.com</a>
        <a href="tel:0123-456-789">0123-456-789</a>
      </div>
    </div>
    <div class="footer-bottom">© 2025 Hệ thống quản lý giao hàng</div>
  </footer>

  <!-- Dropdown -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const chip = document.getElementById('userChip');
    const menu = document.getElementById('userMenu');
    if (chip && menu) {
      chip.addEventListener('click', e => {
        e.stopPropagation();
        menu.classList.toggle('open');
      });
      document.addEventListener('click', () => menu.classList.remove('open'));
    }
  });
  </script>

  <!-- Darkmode -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("themeToggle");
    const icon = toggle.querySelector("i");
    const saved = localStorage.getItem("theme");
    if (saved === "dark") document.documentElement.setAttribute("data-theme", "dark");
    const updateIcon = () => {
      const theme = document.documentElement.getAttribute("data-theme");
      icon.className = theme === "dark" ? "fa-solid fa-sun" : "fa-solid fa-moon";
    };
    updateIcon();
    toggle.addEventListener("click", () => {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      document.documentElement.setAttribute("data-theme", isDark ? "light" : "dark");
      localStorage.setItem("theme", isDark ? "light" : "dark");
      updateIcon();
    });
  });
  </script>

  <!-- Track API -->
  <script>
  (() => {
    const form  = document.getElementById('trackForm');
    const input = document.getElementById('trackInput');
    const box   = document.getElementById('trackResult');
    if (!form) return;

    const esc = s => String(s||'')
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const code = (input?.value || '').trim().toUpperCase();
      if (!code) { box.innerHTML = '<p class="error">Vui lòng nhập mã vận đơn hợp lệ.</p>'; return; }

      box.innerHTML = '<p class="loading"><i class="fa-solid fa-spinner fa-spin"></i> Đang tra cứu...</p>';
      try {
        const res  = await fetch(`/orders/api/track/?code=${encodeURIComponent(code)}`, {credentials:'same-origin'});
        const data = await res.json();

        if (!res.ok) { box.innerHTML = `<p class="error">${esc(data.detail||'Không tra cứu được')}</p>`; return; }

        const cls   = data.status==='done'?'success':data.status==='shipping'?'warning':data.status==='cancel'?'danger':'';
        const badge = `<span class="badge ${cls}"><i class="fa-solid fa-truck"></i> ${esc(data.status_label)}</span>`;

        box.innerHTML = `
          <div class="result-box">
            <div class="result-head"><strong>Mã vận đơn: ${esc(data.code)}</strong>${badge}</div>
            <div style="margin-top:8px">
              <div><b>Khách hàng:</b> ${esc(data.customer_name)}</div>
              <div><b>Địa chỉ:</b> ${esc(data.address||'')}</div>
              <div><b>Điện thoại:</b> ${esc(data.phone||'')}</div>
              <div><b>COD:</b> ${Number(data.cod||0).toLocaleString('vi-VN')}</div>
              <div><b>Nhân viên:</b> ${esc(data.assigned_to||'')}</div>
            </div>
          </div>`;
      } catch {
        box.innerHTML = '<p class="error">Lỗi mạng.</p>';
      }
    });
  })();
  </script>

</body>
</html>
