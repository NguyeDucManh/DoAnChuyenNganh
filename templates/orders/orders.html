{% load static %}
<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</title>
  <link rel="stylesheet" href="{% static 'assets/css/style.css' %}" />
  <style>
    :root{--bg1:#fff6ec;--bg2:#e6f6ff;--card:#ffffff;--line:#e5e7eb;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-h:#1d4ed8}
    body{background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text)}
    .container{max-width:1080px;margin:0 auto;padding:0 16px}
    .wrap{padding:24px;background:var(--card);border-radius:16px;box-shadow:0 10px 26px rgba(2,6,23,.06)}
    .site-header .header-inner{display:flex;align-items:center;justify-content:space-between;height:54px}
    .btn{border:0;padding:8px 14px;border-radius:10px;cursor:pointer;background:var(--primary);color:#fff}
    .btn:hover{background:var(--primary-h)}
    .actions{display:flex;gap:8px;align-items:center}
    input,select{border:1px solid var(--line);border-radius:8px;padding:8px 10px;width:100%}
    form{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    form>div{grid-column:span 6}
    form>.full{grid-column:1/-1}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:15px;vertical-align:middle}
    .suggest-list{list-style:none;margin:4px 0 0;padding:0;max-height:200px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;background:#fff;position:absolute;left:0;right:0;z-index:30;display:none}
    .suggest-list li{padding:8px 10px;cursor:pointer;border-bottom:1px solid #f1f5f9}
    .suggest-list li:hover{background:#f8fafc}
    .toast{position:fixed;bottom:24px;right:24px;background:#111827;color:#fff;padding:10px 16px;border-radius:10px;opacity:0;transition:.3s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
<header class="site-header">
  <div class="header-inner container">
    <a class="brand" href="{% url 'home' %}">Trang chá»§</a>
    <div class="header-actions">
      <span class="user-badge">Xin chÃ o, {{ request.user.username }}</span>
      <button class="btn" onclick="location.href='{% url 'logout' %}'">ÄÄƒng xuáº¥t</button>
    </div>
  </div>
</header>

<section class="crud section">
  <div class="wrap container">
    <h1>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h1>

    <div class="actions" style="gap:12px;margin-bottom:12px">
      <input id="searchBox" placeholder="ğŸ” TÃ¬m theo mÃ£ hoáº·c tÃªn KH..." />
      <select id="filterStatus">
        <option value="">Táº¥t cáº£ tráº¡ng thÃ¡i</option>
        <option value="new">Má»›i táº¡o</option>
        <option value="shipping">Äang giao</option>
        <option value="done">HoÃ n thÃ nh</option>
        <option value="cancel">ÄÃ£ há»§y</option>
      </select>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="checkInBtn"  class="btn">Check-in</button>
        <button id="checkOutBtn" class="btn">Check-out</button>
      </div>
    </div>

    {% if request.user.is_staff %}
    <form id="orderForm">
      {% csrf_token %}
      <input type="hidden" id="orderId" />

      <div>
        <label>TÃªn khÃ¡ch hÃ ng</label>
        <input id="customerName" required />
      </div>
      <div>
        <label>MÃ£ váº­n Ä‘Æ¡n</label>
        <input id="trackingCode" required />
      </div>

      <div style="position:relative">
        <label>Äá»‹a chá»‰ láº¥y hÃ ng</label>
        <input id="pickupAddress" placeholder="VD: 88 Váº¡n Kiáº¿p, BÃ¬nh Tháº¡nh" autocomplete="off" />
        <ul id="pickupSuggestions" class="suggest-list"></ul>
        <input type="hidden" id="pickupLat" />
        <input type="hidden" id="pickupLng" />
        <input id="pickupHouse" placeholder="Sá»‘ nhÃ  (náº¿u cÃ³)" style="margin-top:6px" />
      </div>

      <div style="position:relative">
        <label>Äá»‹a chá»‰ giao hÃ ng</label>
        <input id="dropAddress" placeholder="VD: 86 LÃ½ ThÆ°á»ng Kiá»‡t, TÃ¢n BÃ¬nh" autocomplete="off" />
        <ul id="dropSuggestions" class="suggest-list"></ul>
        <input type="hidden" id="dropLat" />
        <input type="hidden" id="dropLng" />
        <input id="dropHouse" placeholder="Sá»‘ nhÃ  (náº¿u cÃ³)" style="margin-top:6px" />
      </div>

      <div>
        <label>Sá»‘ Ä‘iá»‡n thoáº¡i</label>
        <input id="phone" />
      </div>
      <div>
        <label>Tráº¡ng thÃ¡i</label>
        <select id="status">
          <option value="new">Má»›i táº¡o</option>
          <option value="shipping">Äang giao</option>
          <option value="done">HoÃ n thÃ nh</option>
          <option value="cancel">ÄÃ£ há»§y</option>
        </select>
      </div>
      <div>
        <label>COD (â‚«)</label>
        <input id="cod" type="number" min="0" value="0" />
      </div>
      <div class="actions full">
        <button type="submit" id="submitBtn" class="btn">ThÃªm Ä‘Æ¡n hÃ ng</button>
        <button type="button" id="resetBtn" class="btn" style="background:#6b7280">Clear</button>
      </div>
    </form>
    {% endif %}

    <table id="orderTable">
      <thead>
        <tr>
          <th>ID</th><th>MÃ£ Ä‘Æ¡n</th><th>TÃªn KH</th><th>Äá»‹a chá»‰</th>
          <th>Äiá»‡n thoáº¡i</th><th>COD</th><th>Tráº¡ng thÃ¡i</th><th>NhÃ¢n viÃªn</th><th>Äiá»u phá»‘i</th>
          {% if request.user.is_staff %}<th>HÃ nh Ä‘á»™ng</th>{% endif %}
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 style="margin-top:24px">Báº£ng cháº¥m cÃ´ng</h2>
    <table id="attTable">
      <thead><tr><th>#</th><th>Giá» vÃ o</th><th>Giá» ra</th><th>Tá»•ng giá»</th></tr></thead>
      <tbody><tr><td colspan="4" style="text-align:center;opacity:.6">Äang táº£iâ€¦</td></tr></tbody>
    </table>

    <h2 style="margin-top:24px">Hiá»‡u suáº¥t nhÃ¢n sá»±</h2>
    <div class="actions" style="gap:8px;margin-bottom:8px">
      <input id="perfFrom" type="datetime-local" />
      <input id="perfTo" type="datetime-local" />
      <button id="perfReload" class="btn">Cáº­p nháº­t</button>
    </div>
    <table id="perfTable">
      <thead>
        <tr>
          <th>NhÃ¢n sá»±</th><th>HoÃ n thÃ nh</th><th>Tá»•ng Ä‘Æ¡n</th>
          <th>COD (â‚«)</th><th>Giá» cÃ´ng</th><th>ÄÆ¡n/giá»</th><th>Thá»i gian TB (h)</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="7" style="text-align:center;opacity:.6">Äang táº£iâ€¦</td></tr></tbody>
    </table>
  </div>
</section>

<div id="toast" class="toast"></div>

<script>
  window.APP_IS_STAFF = {{ request.user.is_staff|yesno:"true,false" }};
  window.API_ORDERS = "{% url 'orders:orders-list' %}";
  window.API_ATT    = "{% url 'orders:attendance_api' %}";
  window.API_PERF   = "{% url 'orders:performance_stats' %}";
</script>
<script src="{% static 'assets/js/orders.js' %}"></script>

<!-- ==== ThÃªm láº¡i nÃºt Äiá»u phá»‘i ==== -->
<script>
(function(){
  const tbody = document.querySelector('#orderTable tbody');
  const IS_STAFF = {{ request.user.is_staff|yesno:"true,false" }};
  function addRouteButtons(){
    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      if (tr.querySelector('[data-route-btn]')) return;
      const idCell = tr.querySelector('td');
      if (!idCell) return;
      const id = idCell.textContent.trim();
      const btnTd = document.createElement('td');
      btnTd.innerHTML = `<button data-route-btn class="btn" onclick="location.href='/orders/${id}/'">Äiá»u phá»‘i</button>`;
      const cells = tr.children;
      if (IS_STAFF && cells.length > 0)
        tr.insertBefore(btnTd, cells[cells.length-1]);
      else tr.appendChild(btnTd);
    });
  }
  new MutationObserver(addRouteButtons).observe(tbody, {childList:true, subtree:true});
  document.addEventListener('DOMContentLoaded', addRouteButtons);
})();
</script>

<!-- ==== Autocomplete Æ°u tiÃªn BÃ¬nh Tháº¡nh ==== -->
<script>
const BTH={W:106.677,E:106.740,S:10.784,N:10.858};
const inBinhThanh=(lat,lon)=>lon>=BTH.W&&lon<=BTH.E&&lat>=BTH.S&&lat<=BTH.N;

function initAutoAddress(inputId,sugId,houseId,latId,lngId){
  const inp=document.getElementById(inputId);
  const sug=document.getElementById(sugId);
  const house=document.getElementById(houseId);
  const lat=document.getElementById(latId);
  const lng=document.getElementById(lngId);
  let timer;
  async function search(q){
    const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&countrycodes=VN&limit=8&q=${encodeURIComponent(q)}`;
    const r=await fetch(url,{headers:{'Accept-Language':'vi','User-Agent':'deliverysys-demo'}});
    const list=r.ok?await r.json():[];
    list.sort((a,b)=>{
      const sa=((a.display_name||'').includes('BÃ¬nh Tháº¡nh')||inBinhThanh(+a.lat,+a.lon))?1:0;
      const sb=((b.display_name||'').includes('BÃ¬nh Tháº¡nh')||inBinhThanh(+b.lat,+b.lon))?1:0;
      return sb-sa;
    });
    return list;
  }
  function render(list){
    if(!list.length){sug.style.display='none';return;}
    sug.innerHTML=list.map(p=>`<li data-lat="${p.lat}" data-lon="${p.lon}" data-house="${p.address?.house_number||''}">${p.display_name}</li>`).join('');
    sug.style.display='block';
  }
  inp.addEventListener('input',()=>{
    clearTimeout(timer);
    const q=inp.value.trim();
    if(q.length<3){sug.style.display='none';return;}
    timer=setTimeout(async()=>{try{render(await search(q));}catch{sug.style.display='none';}},300);
  });
  sug.addEventListener('click',e=>{
    const li=e.target.closest('li');if(!li)return;
    inp.value=li.textContent.trim();
    lat.value=li.dataset.lat;
    lng.value=li.dataset.lon;
    house.value=li.dataset.house;
    sug.style.display='none';
  });
  document.addEventListener('click',e=>{
    if(!sug.contains(e.target)&&e.target!==inp)sug.style.display='none';
  });
}
initAutoAddress('pickupAddress','pickupSuggestions','pickupHouse','pickupLat','pickupLng');
initAutoAddress('dropAddress','dropSuggestions','dropHouse','dropLat','dropLng');
</script>
</body>
</html>
